{% extends "base.html" %}

{% block content %}
<h1>Play game {{ game.gameID }}</h1>

<style>
    .chess-board-box {
        background: #222;
        color: #eee;
        padding: 12px 16px;
        display: inline-block;
        border-radius: 8px;
        border: 2px solid #555;
        font-family: "Courier New", monospace;
        font-size: 16px;
        line-height: 1.3;
        margin-bottom: 1em;
        white-space: pre-line;
    }
    .status-bar {
        margin-bottom: 0.5em;
    }
    .status-bar strong {
        color: #ffd54f;
    }
    .flash-msg {
        margin: 0.5em 0;
        padding: 0.5em 0.8em;
        border-radius: 6px;
    }
    .flash-error {
        background: #4a1c1c;
        color: #ffb3b3;
        border: 1px solid #ff6666;
    }
    .flash-info {
        background: #1d3a26;
        color: #b6f0c2;
        border: 1px solid #66cc88;
    }
</style>

{% if error %}
    <div class="flash-msg flash-error">
        {{ error }}
    </div>
{% endif %}

{% if info %}
    <div class="flash-msg flash-info">
        {{ info }}
    </div>
{% endif %}

<div class="layout-two-col">
    <div class="col-left">
        <div class="card">
            <div class="status-bar">
                Side to move: <strong>{{ side_to_move }}</strong>
            </div>

            <div class="chess-board-box">
            {{ board_ascii }}
            </div>

            <form method="POST" style="margin-bottom: 0.75em;">
                <label for="san">
                    Enter move (SAN, e.g. <code>e4</code>, <code>Nf3</code>,
                    <code>O-O</code>, or <code>1-0</code> to set result):
                </label><br>
                <input type="text" id="san" name="san" autocomplete="off" style="width: 220px;">
                <button type="submit">Submit move</button>
            </form>

            <form method="POST">
                <!-- This button posts command='resign' -->
                <button type="submit" name="command" value="resign"
                        onclick="return confirm('Are you sure you want to resign?');">
                    Resign
                </button>
            </form>

            <br>
            <a href="/games">Back to games list</a>
        </div>
    </div>

    <div class="col-right">
        <div class="card">
            <h3>Moves</h3>

            {% if moves %}
                <ol>
                    {% for mv in moves %}
                        <li>{{ mv.madeBy }}: {{ mv.move }}</li>
                    {% endfor %}
                </ol>
            {% else %}
                <p>No moves yet. Enter the first move below.</p>
            {% endif %}
        </div>
    </div>
</div>

<!--  Auto-refresh polling -->
<script>
(function() {

    // Safely inject server values (Jinja -> JS)
    const initialMoveCount = {{ moves|length|tojson }};
    const initialResult = {{ (game.result or "")|tojson }};
    const apiUrl = {{ url_for('api_game_state', gameKey=game.gameKey)|tojson }};

    async function checkForUpdates() {
        try {
            const resp = await fetch(apiUrl, { cache: "no-store" });
            if (!resp.ok) return;

            const data = await resp.json();
            if (!data.success) return;

            const moveCount = (data.moves || []).length;
            const result = data.game && data.game.result ? data.game.result : "";

            if (moveCount > initialMoveCount || result !== initialResult) {
                window.location.reload();
            }
        } catch (err) {
            console.log("Error polling game state:", err);
        }
    }

    setInterval(checkForUpdates, 3000);
})();
</script>

{% endblock %}
